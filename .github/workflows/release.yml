name: Release

on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-26
    environment: release
    env:
      APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
      APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Select Xcode toolchain
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Validate Xcode version
        run: |
          xcodebuild -version
          XCODE_MAJOR="$(xcodebuild -version | awk '/^Xcode /{split($2, v, "."); print v[1]}')"
          if [[ -z "$XCODE_MAJOR" ]]; then
            echo "error: unable to determine Xcode major version from xcodebuild -version" >&2
            exit 1
          fi
          if [[ "$XCODE_MAJOR" -lt 26 ]]; then
            echo "error: release build requires Xcode 26+ to match the CI/local toolchain baseline" >&2
            exit 1
          fi

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "error: tag '$TAG' does not match semver pattern" >&2
            exit 1
          fi
          PROJECT_VERSION=$(grep 'MARKETING_VERSION' project.yml | head -1 | sed 's/.*: *"\(.*\)"/\1/')
          if [[ "$VERSION" != "$PROJECT_VERSION" ]]; then
            echo "error: tag version '$VERSION' does not match project.yml MARKETING_VERSION '$PROJECT_VERSION'" >&2
            exit 1
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
          echo "TAG=$TAG" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"

      - name: Install build dependencies
        run: |
          for pkg in xcbeautify xcodegen create-dmg; do
            if ! brew list "$pkg" &>/dev/null; then
              brew install "$pkg"
            fi
          done

      - name: Generate Xcode project
        run: scripts/regenerate_xcodeproj.sh

      - name: Build
        run: make build

      - name: Test
        run: make coverage

      - name: Test coverage gate integration
        run: make test-coverage-gate

      - name: Setup signing
        env:
          APPLE_API_PRIVATE_KEY_B64: ${{ secrets.APPLE_API_PRIVATE_KEY_B64 }}
          DEVELOPER_ID_APP_P12_B64: ${{ secrets.DEVELOPER_ID_APP_P12_B64 }}
          DEVELOPER_ID_APP_P12_PASSWORD: ${{ secrets.DEVELOPER_ID_APP_P12_PASSWORD }}
          DEVELOPER_ID_INSTALLER_P12_B64: ${{ secrets.DEVELOPER_ID_INSTALLER_P12_B64 }}
          DEVELOPER_ID_INSTALLER_P12_PASSWORD: ${{ secrets.DEVELOPER_ID_INSTALLER_P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: scripts/ci_setup_signing.sh

      - name: Archive and export
        env:
          DEVELOPER_ID_APP_IDENTITY: ${{ secrets.DEVELOPER_ID_APP_IDENTITY }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: scripts/ci_archive.sh

      - name: Package artifacts
        env:
          DEVELOPER_ID_APP_IDENTITY: ${{ secrets.DEVELOPER_ID_APP_IDENTITY }}
          DEVELOPER_ID_INSTALLER_IDENTITY: ${{ secrets.DEVELOPER_ID_INSTALLER_IDENTITY }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          CLI_INSTALL_PATH: ${{ vars.CLI_INSTALL_PATH }}
        run: scripts/ci_package.sh

      - name: Notarize DMG
        run: scripts/ci_notarize.sh "$RUNNER_TEMP/artifacts/AgentPanel-v${{ steps.version.outputs.VERSION }}-macos-arm64.dmg"

      - name: Notarize PKG
        run: scripts/ci_notarize.sh "$RUNNER_TEMP/artifacts/ap-v${{ steps.version.outputs.VERSION }}-macos-arm64.pkg"

      - name: Validate artifacts
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: scripts/ci_release_validate.sh

      - name: Generate checksums
        run: |
          cd "$RUNNER_TEMP/artifacts"
          shasum -a 256 \
            "AgentPanel-v${{ steps.version.outputs.VERSION }}-macos-arm64.dmg" \
            "ap-v${{ steps.version.outputs.VERSION }}-macos-arm64.pkg" \
            "ap-v${{ steps.version.outputs.VERSION }}-macos-arm64.tar.gz" \
            > SHA256SUMS
          cat SHA256SUMS

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          TAG="${{ steps.version.outputs.TAG }}"
          gh release create "$TAG" \
            --title "AgentPanel $TAG" \
            --generate-notes \
            "$RUNNER_TEMP/artifacts/AgentPanel-v${VERSION}-macos-arm64.dmg" \
            "$RUNNER_TEMP/artifacts/ap-v${VERSION}-macos-arm64.pkg" \
            "$RUNNER_TEMP/artifacts/ap-v${VERSION}-macos-arm64.tar.gz" \
            "$RUNNER_TEMP/artifacts/SHA256SUMS"

      - name: Cleanup signing material
        if: always()
        run: |
          security delete-keychain "$RUNNER_TEMP/release.keychain-db" 2>/dev/null || true
          rm -rf "$RUNNER_TEMP/signing" 2>/dev/null || true
